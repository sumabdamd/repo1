name: Process file autogenerated PRs
on:
  workflow_dispatch:
  workflow_call:
permissions:
  contents: write
  pull-requests: write
jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: clean up repo if it exists
        run: |
          echo '${{ toJson(github) }}'
          cd $GITHUB_WORKSPACE
          rm -rf repo1
          
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Find one PR matching "score check details" in title
        id: find_pr
        run: |
          echo "get oldest PR_NUMBER"
          PR_NUMBERS=$(gh pr list --repo $GITHUB_REPOSITORY --limit 200 --json title,number --jq '.[] | select(.title | test("score check details")) | .number' | sort -n) 
          echo "PR_NUMBERS"
          echo $PR_NUMBERS
          if [ -z "$PR_NUMBERS" ]; then
            echo "No PR number found for matched title."
          else
            for i in $PR_NUMBERS
            do
              echo "Merging PR https://github.com/sumabdamd/repo1/pull/$i ..."
              gh pr merge "$i" --merge --delete-branch || echo "Failed to merge PR $i"
            done
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
      # Remove repo
      - name: clean up repo
        run: |
          cd $GITHUB_WORKSPACE
          rm -rf repo1
